<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>みなみ歯科医院｜お問い合わせ</title>
  <style>
    :root { --bg:#f6f4f0; --card:#ffffff; --text:#1a1a1a; --muted:#6b6560; --line:#d6cfc8; --btn:#8b7355; --btn-hover:#74603f; --danger:#c0392b; --accent:#b8a88a; }
    body { margin:0; font-family: "Hiragino Mincho ProN", "Noto Serif JP", "Yu Mincho", serif; background:linear-gradient(180deg,#f6f4f0,#ede8e1); color:var(--text); }
    .wrap { max-width:900px; margin:0 auto; padding:18px; }
    .header { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap; }
    .badges { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .badge { font-size:12px; padding:6px 12px; border:1px solid var(--accent); border-radius:999px; color:var(--muted); letter-spacing:.5px; }
    .actions { display:flex; gap:8px; }
    .ghostbtn {
      font-size:12px; padding:8px 12px; border:1px solid var(--line); border-radius:12px;
      background:transparent; color:var(--muted); cursor:pointer; transition:all .2s;
    }
    .ghostbtn:hover { background:rgba(139,115,85,.08); border-color:var(--accent); }
    .danger { border-color:rgba(192,57,43,.4); color:#a93226; }
    .danger:hover { background:rgba(192,57,43,.06); }
    .card { background:var(--card); border:1px solid var(--line); border-radius:16px; overflow:hidden; box-shadow:0 8px 32px rgba(100,80,60,.1); }
    .notice { padding:14px 16px; border-bottom:1px solid var(--line); color:var(--muted); font-size:13px; line-height:1.7; background:linear-gradient(180deg,#faf8f5,#fff); }
    .notice b { color:var(--text); }
    .profileLine { padding:10px 16px; border-bottom:1px solid var(--line); font-size:12px; color:var(--muted); display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; background:#fdfcfa; }
    .chat { height:62vh; min-height:420px; overflow:auto; padding:16px; display:flex; flex-direction:column; gap:10px; background:#faf8f5; }
    .msg { max-width:85%; padding:11px 14px; border-radius:14px; border:1px solid var(--line); white-space:pre-wrap; line-height:1.65; font-family:system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif; font-size:14px; }
    .me { align-self:flex-end; background:linear-gradient(135deg,#8b7355,#a08960); color:#fff; border-color:transparent; }
    .ai { align-self:flex-start; background:#fff; border-color:#e0d9d0; }
    .bar { display:flex; gap:10px; padding:12px 14px; border-top:1px solid var(--line); background:#fdfcfa; }
    textarea { flex:1; resize:none; border-radius:12px; border:1px solid var(--line); background:#fff; color:var(--text); padding:10px 12px; min-height:44px; max-height:160px; outline:none; font-family:inherit; transition:border-color .2s; }
    textarea:focus { border-color:var(--accent); }
    button.send { width:120px; border:0; border-radius:12px; background:var(--btn); color:white; font-weight:700; cursor:pointer; transition:background .2s; letter-spacing:.5px; }
    button.send:hover { background:var(--btn-hover); }
    button.send:disabled { opacity:.45; cursor:not-allowed; }
    .small { font-size:12px; color:var(--muted); margin-top:10px; line-height:1.6; }
    a { color:#8b7355; }
    .divider { height:1px; background:var(--line); margin:10px 0; opacity:.6; }

    /* ---- 選択ボタン ---- */
    .choice-btns { display:flex; gap:8px; flex-wrap:wrap; align-self:flex-start; margin-top:2px; }
    .choice-btn {
      padding:9px 18px; border:1px solid var(--accent); border-radius:20px;
      background:#fff; color:var(--btn); cursor:pointer; font-size:13px;
      font-family:system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      transition:all .2s; line-height:1.4;
    }
    .choice-btn:hover { background:var(--btn); color:#fff; }
    .choice-btn:disabled { opacity:.4; cursor:not-allowed; background:#f0ece6; color:#999; border-color:#ddd; }

    /* ---- チャット終了ボタン ---- */
    .end-chat-btn {
      display:block; margin:12px auto 4px; padding:12px 28px;
      border:2px solid var(--danger); border-radius:24px;
      background:#fff; color:var(--danger); font-size:14px; font-weight:700;
      cursor:pointer; transition:all .2s; letter-spacing:.5px;
      font-family:system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
    }
    .end-chat-btn:hover { background:var(--danger); color:#fff; }

    /* ---- プロフィール入力モーダル ---- */
    .modal-overlay {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center;
      z-index:1000; opacity:0; transition:opacity .25s; pointer-events:none;
    }
    .modal-overlay.open { opacity:1; pointer-events:auto; }
    .modal-card {
      background:#fff; border-radius:16px; padding:28px 24px; max-width:380px; width:90%;
      box-shadow:0 12px 40px rgba(0,0,0,.15); transform:translateY(20px); transition:transform .25s;
    }
    .modal-overlay.open .modal-card { transform:translateY(0); }
    .modal-card h3 { margin:0 0 10px; font-size:16px; letter-spacing:.5px; }
    .modal-card .modal-desc { font-size:13px; color:var(--muted); line-height:1.6; margin:0 0 18px; }
    .modal-field { margin-bottom:16px; }
    .modal-field label { font-size:13px; color:var(--text); display:block; margin-bottom:6px; font-weight:600; }
    .modal-field input[type="text"] {
      width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px;
      font-size:14px; box-sizing:border-box; outline:none; transition:border-color .2s;
      font-family:system-ui, sans-serif;
    }
    .modal-field input[type="text"]:focus { border-color:var(--accent); }
    .dob-row { display:flex; gap:6px; align-items:center; }
    .dob-row select {
      padding:10px 6px; border:1px solid var(--line); border-radius:10px;
      font-size:14px; flex:1; outline:none; background:#fff; color:var(--text);
      font-family:system-ui, sans-serif;
    }
    .dob-row select:focus { border-color:var(--accent); }
    .dob-lbl { font-size:13px; color:var(--muted); min-width:16px; text-align:center; }
    .consent-row {
      display:flex; align-items:flex-start; gap:10px; margin-bottom:20px;
      cursor:pointer; font-size:13px; line-height:1.5; color:var(--text);
    }
    .consent-row input[type="checkbox"] { width:18px; height:18px; margin-top:2px; flex-shrink:0; accent-color:var(--btn); }
    .modal-submit {
      width:100%; padding:13px; border:none; border-radius:12px;
      background:var(--btn); color:#fff; font-size:14px; font-weight:700;
      cursor:pointer; transition:background .2s; letter-spacing:.5px;
    }
    .modal-submit:hover { background:var(--btn-hover); }
    .modal-submit:disabled { opacity:.35; cursor:not-allowed; }
    .modal-error { color:var(--danger); font-size:12px; margin-bottom:12px; display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="badges">
        <div class="badge">お問い合わせAI（β）</div>
        <div class="badge">必要に応じて受診をご案内します</div>
      </div>
      <div class="actions">
        <button id="editProfile" class="ghostbtn">入力情報を変更</button>
        <button id="resetProfile" class="ghostbtn danger">入力情報リセット</button>
      </div>
    </div>

    <div class="card">
      <div class="notice">
        <b>ご注意</b>：このチャットは診断の確定は行いません。<br>
        強い腫れ／出血が止まらない／息苦しさ／外傷など緊急性がある場合は、救急や医療機関へご連絡ください。<br>
        <span style="opacity:.9;">※院内で対応内容を確認するため、会話内容は記録されます（同意のうえご利用ください）。</span>
      </div>

      <div id="profileLine" class="profileLine">
        <div>ログ識別：<span id="profileStatus">未入力</span></div>
        <div>セッション：<span id="sessionStatus">未作成</span></div>
      </div>

      <div id="chat" class="chat"></div>

      <div class="bar">
        <textarea id="input" placeholder="例：歯がしみる／詰め物が取れた／腫れてきた など"></textarea>
        <button id="send" class="send">送信</button>
      </div>
    </div>

    <div class="small">
      ・会話履歴はこの端末内（ブラウザ）に保存されます。共有端末の場合は「入力情報リセット」を押してください。<br>
      ・予約や個別対応が必要な場合は、電話や来院をご案内します。
    </div>
  </div>

  <!-- プロフィール入力モーダル -->
  <div id="profileModal" class="modal-overlay">
    <div class="modal-card">
      <h3>ご利用にあたって</h3>
      <p class="modal-desc">このチャット内容は、院内で内容確認・対応のために保存されます。<br>以下をご入力のうえ「開始」を押してください。</p>

      <label class="consent-row">
        <input type="checkbox" id="modalConsent">
        <span>上記の記録・保存に同意します</span>
      </label>

      <div class="modal-field">
        <label>患者氏名（フルネーム）</label>
        <input type="text" id="modalName" placeholder="例：山田 太郎" autocomplete="name">
      </div>

      <div class="modal-field">
        <label>生年月日</label>
        <div class="dob-row">
          <select id="dobYear"><option value="">--</option></select><span class="dob-lbl">年</span>
          <select id="dobMonth"><option value="">--</option></select><span class="dob-lbl">月</span>
          <select id="dobDay"><option value="">--</option></select><span class="dob-lbl">日</span>
        </div>
      </div>

      <div id="modalError" class="modal-error"></div>
      <button id="modalSubmit" class="modal-submit" disabled>確認して開始</button>
    </div>
  </div>

<script>
  // ★ここだけ確認：あなたのWorkerのURL
  const API_URL = "https://minami-inquiry-ai.373minami-dc.workers.dev/api/chat";

  const chatEl = document.getElementById("chat");
  const inputEl = document.getElementById("input");
  const sendBtn = document.getElementById("send");
  const profileStatusEl = document.getElementById("profileStatus");
  const sessionStatusEl = document.getElementById("sessionStatus");
  const editProfileBtn = document.getElementById("editProfile");
  const resetProfileBtn = document.getElementById("resetProfile");

  const STORAGE_KEY = "minami_inquiry_chat_v1";
  const PROFILE_KEY = "minami_patient_profile_v1";
  const SESSION_KEY = "minami_inquiry_session_v1";

  let messages = loadMessages();
  let faqFlow = null;

  /* ====== localStorage ====== */
  function loadMessages() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
    catch { return []; }
  }
  function saveMessages() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(messages.slice(-30)));
  }

  function getOrCreateSessionId() {
    let id = localStorage.getItem(SESSION_KEY);
    if (id) return id;
    id = (crypto?.randomUUID?.() || ("s_" + Date.now() + "_" + Math.random().toString(16).slice(2)));
    localStorage.setItem(SESSION_KEY, id);
    return id;
  }

  function getProfile() {
    try { return JSON.parse(localStorage.getItem(PROFILE_KEY)) || null; } catch { return null; }
  }
  function setProfile(p) {
    localStorage.setItem(PROFILE_KEY, JSON.stringify(p));
    refreshStatus();
  }
  function clearProfile() {
    localStorage.removeItem(PROFILE_KEY);
    localStorage.removeItem(SESSION_KEY);
    refreshStatus();
  }

  /* ====== プロフィールモーダル ====== */
  const modalEl       = document.getElementById("profileModal");
  const modalConsent  = document.getElementById("modalConsent");
  const modalName     = document.getElementById("modalName");
  const dobYearEl     = document.getElementById("dobYear");
  const dobMonthEl    = document.getElementById("dobMonth");
  const dobDayEl      = document.getElementById("dobDay");
  const modalSubmit   = document.getElementById("modalSubmit");
  const modalError    = document.getElementById("modalError");

  // ドロップダウン初期化
  (function initDobSelects() {
    const thisYear = new Date().getFullYear();
    for (let y = thisYear; y >= 1920; y--) {
      const o = document.createElement("option"); o.value = y; o.textContent = y;
      dobYearEl.appendChild(o);
    }
    for (let m = 1; m <= 12; m++) {
      const o = document.createElement("option"); o.value = m; o.textContent = m;
      dobMonthEl.appendChild(o);
    }
    for (let d = 1; d <= 31; d++) {
      const o = document.createElement("option"); o.value = d; o.textContent = d;
      dobDayEl.appendChild(o);
    }
  })();

  let _profileResolve = null;

  function ensureProfile(forceReinput = false) {
    return new Promise((resolve) => {
      if (!forceReinput) {
        const existing = getProfile();
        if (existing && existing.name && existing.dob && existing.consent === true) {
          resolve(existing);
          return;
        }
      }
      _profileResolve = resolve;
      openProfileModal();
    });
  }

  function openProfileModal() {
    // 既存プロフィールがあれば事前入力
    const existing = getProfile();
    if (existing) {
      modalConsent.checked = true;
      modalName.value = existing.name || "";
      if (existing.dob) {
        const p = existing.dob.split("-");
        if (p.length === 3) {
          dobYearEl.value = parseInt(p[0]) || "";
          dobMonthEl.value = parseInt(p[1]) || "";
          dobDayEl.value = parseInt(p[2]) || "";
        }
      }
    } else {
      modalConsent.checked = false;
      modalName.value = "";
      dobYearEl.value = "";
      dobMonthEl.value = "";
      dobDayEl.value = "";
    }
    modalError.style.display = "none";
    updateModalSubmitState();
    modalEl.classList.add("open");
  }

  function closeProfileModal(result) {
    modalEl.classList.remove("open");
    if (_profileResolve) {
      _profileResolve(result);
      _profileResolve = null;
    }
  }

  function updateModalSubmitState() {
    const ok = modalConsent.checked
      && modalName.value.trim()
      && dobYearEl.value
      && dobMonthEl.value
      && dobDayEl.value;
    modalSubmit.disabled = !ok;
  }

  modalConsent.addEventListener("change", updateModalSubmitState);
  modalName.addEventListener("input", updateModalSubmitState);
  dobYearEl.addEventListener("change", updateModalSubmitState);
  dobMonthEl.addEventListener("change", updateModalSubmitState);
  dobDayEl.addEventListener("change", updateModalSubmitState);

  modalSubmit.addEventListener("click", () => {
    const name = modalName.value.trim();
    const y = dobYearEl.value;
    const m = String(dobMonthEl.value).padStart(2, "0");
    const d = String(dobDayEl.value).padStart(2, "0");
    if (!name || !y || !m || !d) return;

    const dob = y + "-" + m + "-" + d;
    const p = { name, dob, consent: true, updated_at: new Date().toISOString() };
    setProfile(p);
    getOrCreateSessionId();
    closeProfileModal(p);
  });

  // モーダル背景クリックでキャンセル
  modalEl.addEventListener("click", (e) => {
    if (e.target === modalEl) closeProfileModal(null);
  });

  /* ====== ステータス表示 ====== */
  function refreshStatus() {
    const p = getProfile();
    const sid = localStorage.getItem(SESSION_KEY);
    profileStatusEl.textContent = (p && p.name && p.dob) ? (p.name + " / " + p.dob) : "未入力";
    sessionStatusEl.textContent = sid || "未作成";
  }

  /* ====== チャット描画 ====== */
  function addBubble(role, text, source, options) {
    const div = document.createElement("div");
    div.className = "msg " + (role === "user" ? "me" : "ai");
    div.textContent = text;
    if (source && role === "assistant") {
      const tag = document.createElement("div");
      tag.style.cssText = "font-size:10px;color:#888;margin-top:4px;";
      tag.textContent = "[source: " + source + "]";
      div.appendChild(tag);
    }
    chatEl.appendChild(div);

    // 選択ボタン
    if (options && Array.isArray(options) && options.length > 0 && role === "assistant") {
      const row = document.createElement("div");
      row.className = "choice-btns";
      for (const opt of options) {
        const btn = document.createElement("button");
        btn.className = "choice-btn";
        btn.textContent = opt.label;
        btn.addEventListener("click", () => {
          row.querySelectorAll("button").forEach(b => { b.disabled = true; });
          inputEl.value = opt.value;
          send();
        });
        row.appendChild(btn);
      }
      chatEl.appendChild(row);
    }

    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function addEndChatButton() {
    const btn = document.createElement("button");
    btn.className = "end-chat-btn";
    btn.textContent = "チャットを終了する";
    btn.addEventListener("click", () => {
      messages = [];
      faqFlow = null;
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(SESSION_KEY);
      refreshStatus();
      render();
    });
    chatEl.appendChild(btn);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function render() {
    chatEl.innerHTML = "";
    if (messages.length === 0) {
      addBubble("assistant",
        "こんにちは。症状や状況を教えてください。\n" +
        "例：いつから／どの歯（右上など）／痛み・しみ・腫れ／治療中の歯か など\n\n" +
        "※送信前に、ログ確認のため氏名・生年月日入力（同意）が出ます。"
      );
      return;
    }
    for (const m of messages) addBubble(m.role, m.content);
    if (messages.length > 0 && messages[messages.length - 1].suggest_end) {
      addEndChatButton();
    }
  }

  /* ====== 送信 ====== */
  async function send() {
    const text = inputEl.value.trim();
    if (!text) return;

    // プロフィール未入力ならモーダル表示（非同期）
    const profile = await ensureProfile(false);
    if (!profile) {
      addBubble("assistant", "同意・氏名・生年月日の入力が確認できないため、送信を中止しました。");
      return;
    }
    const sessionId = getOrCreateSessionId();

    messages.push({ role:"user", content:text });
    addBubble("user", text);
    inputEl.value = "";
    saveMessages();

    sendBtn.disabled = true;
    sendBtn.textContent = "送信中";

    try {
      const payload = {
        session_id: sessionId,
        patient: { name: profile.name, dob: profile.dob },
        user_agent: navigator.userAgent,
        page_url: location.href,
        messages: messages,
        faq_flow: faqFlow
      };

      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const errText = await res.text().catch(()=> "");
        throw new Error("API error: " + res.status + " " + errText);
      }

      const data = await res.json();
      const reply = data.reply || "すみません、うまく回答できませんでした。もう一度お試しください。";

      faqFlow = data.faq_flow || null;

      const msgObj = { role:"assistant", content:reply };
      if (data.suggest_end) msgObj.suggest_end = true;
      messages.push(msgObj);
      addBubble("assistant", reply, data.source, data.reply_options || null);
      if (data.suggest_end) addEndChatButton();
      saveMessages();
    } catch (e) {
      addBubble("assistant", "通信エラーが発生しました。もう一度お試しください。\n（" + e.message + "）");
    } finally {
      sendBtn.disabled = false;
      sendBtn.textContent = "送信";
    }
  }

  /* ====== UI イベント ====== */
  sendBtn.addEventListener("click", send);
  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send(); }
  });

  editProfileBtn.addEventListener("click", async () => {
    const p = await ensureProfile(true);
    if (p) addBubble("assistant", "入力情報を更新しました。");
  });

  resetProfileBtn.addEventListener("click", () => {
    const ok = confirm("入力情報（氏名・生年月日）とセッションIDを削除します。よろしいですか？");
    if (!ok) return;
    clearProfile();
    addBubble("assistant", "入力情報をリセットしました。必要に応じて再入力してください。");
  });

  // 初期化
  refreshStatus();
  render();
</script>
</body>
</html>
