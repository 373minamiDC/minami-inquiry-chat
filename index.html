<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>みなみ歯科医院｜お問い合わせAI</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a2e;
      --ink:#e7eefc;
      --muted:#a8b4d1;
      --line:#1e2b49;
      --btn:#1f4fd6;
      --btn2:#2a3554;
      --danger:#b33a3a;
    }
    body{margin:0;background:linear-gradient(180deg,#070b14, #0b1220);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;}
    .wrap{max-width:980px;margin:0 auto;padding:20px;}
    .panel{background:rgba(15,26,46,.92);border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden;}
    .head{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .head .title{font-weight:700}
    .head .sub{color:var(--muted);font-size:12px}
    .notice{padding:12px 16px;border-bottom:1px solid var(--line);color:var(--muted);font-size:12px;line-height:1.6}
    .meta{padding:8px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:12px;}
    .chat{height:520px;overflow:auto;padding:14px 16px;background:rgba(8,14,26,.4);}
    .row{display:flex;margin:10px 0;gap:10px;}
    .row.user{justify-content:flex-end;}
    .bubble{max-width:78%;padding:10px 12px;border-radius:14px;border:1px solid var(--line);white-space:pre-wrap;word-break:break-word;line-height:1.55;}
    .assistant .bubble{background:rgba(15,26,46,.9);}
    .user .bubble{background:rgba(31,79,214,.22);border-color:rgba(31,79,214,.5);}
    a{color:#8fb3ff}
    .chips{display:flex;flex-wrap:wrap;gap:8px;padding:10px 16px;border-top:1px solid var(--line);background:rgba(15,26,46,.92);}
    .chip{border:1px solid var(--line);background:rgba(42,53,84,.55);color:var(--ink);padding:7px 10px;border-radius:999px;font-size:12px;cursor:pointer;}
    .chip:hover{filter:brightness(1.1);}
    .input{display:flex;gap:10px;padding:12px 16px;border-top:1px solid var(--line);align-items:center;background:rgba(15,26,46,.92);}
    textarea{flex:1;resize:none;height:44px;max-height:120px;border-radius:12px;border:1px solid var(--line);background:rgba(8,14,26,.6);color:var(--ink);padding:10px 12px;outline:none;}
    .btn{border:0;border-radius:12px;padding:10px 14px;color:white;cursor:pointer;font-weight:700;}
    .btn.primary{background:var(--btn);}
    .btn.ghost{background:var(--btn2);border:1px solid var(--line);color:var(--ink);}
    .btn.danger{background:rgba(179,58,58,.16);border:1px solid rgba(179,58,58,.5);color:#ffd3d3;}
    .foot{padding:8px 16px;color:var(--muted);font-size:11px;border-top:1px solid var(--line);display:flex;justify-content:space-between;gap:10px;background:rgba(15,26,46,.92);}
    .rightBtns{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    /* modal */
    .modalBg{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:18px;}
    .modal{width:min(560px,100%);background:rgba(15,26,46,.98);border:1px solid var(--line);border-radius:14px;box-shadow:0 14px 50px rgba(0,0,0,.6);padding:16px;}
    .modal h2{margin:0 0 8px 0;font-size:18px;}
    .modal p{margin:6px 0;color:var(--muted);font-size:13px;line-height:1.6;}
    .modal label{display:block;margin-top:10px;color:var(--muted);font-size:12px;}
    .modal input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(8,14,26,.6);color:var(--ink);outline:none;margin-top:6px;}
    .modalBtns{display:flex;gap:10px;justify-content:flex-end;margin-top:14px;flex-wrap:wrap;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="head">
        <div>
          <div class="title">お問い合わせAI</div>
          <div class="sub">必要に応じて受診をご案内します</div>
        </div>
        <div class="sub" id="statusText">接続準備中…</div>
      </div>

      <div class="notice">
        ※このチャットは診断の確定は行いません。<br>
        強い痛み／出血が止まらない／息苦しさ／外傷など緊急性がある場合は、当院までお電話ください（診療時間内のみ対応）：<b>0798-47-8111</b>
      </div>

      <div class="meta">
        <div id="patientMeta">ログ識別：未設定</div>
        <div id="sessionMeta">セッション：-</div>
      </div>

      <div class="chat" id="chat"></div>

      <div class="chips">
        <button class="chip" data-text="痛い">痛い</button>
        <button class="chip" data-text="詰め物が取れた">詰め物が取れた</button>
        <button class="chip" data-text="しみる">しみる</button>
        <button class="chip" data-text="腫れた">腫れた</button>
      </div>

      <div class="input">
        <textarea id="input" placeholder="例：今日 右上の奥歯の詰め物が取れた など"></textarea>
        <button class="btn primary" id="sendBtn">送信</button>
      </div>

      <div class="foot">
        <div>共用端末の場合は「会話を終了（履歴を消す）」を押してください（氏名・生年月日は残ります）。</div>
        <div class="rightBtns">
          <button class="btn ghost" id="endBtn" style="display:none;">会話を終了（履歴を消す）</button>
          <button class="btn danger" id="resetPatientBtn">入力情報リセット</button>
        </div>
      </div>
    </div>
  </div>

  <!-- modal -->
  <div class="modalBg" id="modalBg">
    <div class="modal">
      <h2>ご利用前の確認</h2>
      <p>
        このチャットは診断の確定は行いません。緊急性がある場合はお電話ください（診療時間内のみ対応）：<b>0798-47-8111</b><br>
        会話内容は院内で確認のため記録されます。
      </p>

      <label>同意（「同意します」と入力）</label>
      <input id="consentInput" placeholder="同意します" />

      <label>お名前</label>
      <input id="nameInput" placeholder="例：山田 太郎" />

      <label>生年月日（YYYY-MM-DD）</label>
      <input id="dobInput" placeholder="例：1993-06-30" />

      <div class="modalBtns">
        <button class="btn ghost" id="cancelModalBtn">閉じる</button>
        <button class="btn primary" id="saveModalBtn">開始</button>
      </div>
    </div>
  </div>

<script>
  // ========= API（固定） =========
  const WORKER_BASE = "https://minami-inquiry-ai.373minami-dc.workers.dev";
  const API_CHAT = WORKER_BASE + "/api/chat";
  const API_PING = WORKER_BASE + "/ping";

  // ========= localStorage keys =========
  const LS_PATIENT = "minami_patient";        // keep
  const LS_SESSION = "minami_session_id";     // clear on end
  const LS_MESSAGES = "minami_chat_messages"; // clear on end
  const LS_FLOW = "minami_faq_flow";          // clear on end

  // ========= state =========
  let patient = null;
  let sessionId = null;
  let messages = [];
  let faqFlow = null;

  const elChat = document.getElementById("chat");
  const elInput = document.getElementById("input");
  const elSend = document.getElementById("sendBtn");
  const elStatus = document.getElementById("statusText");
  const elPatientMeta = document.getElementById("patientMeta");
  const elSessionMeta = document.getElementById("sessionMeta");
  const elEndBtn = document.getElementById("endBtn");
  const elResetPatientBtn = document.getElementById("resetPatientBtn");

  // modal
  const modalBg = document.getElementById("modalBg");
  const consentInput = document.getElementById("consentInput");
  const nameInput = document.getElementById("nameInput");
  const dobInput = document.getElementById("dobInput");
  const saveModalBtn = document.getElementById("saveModalBtn");
  const cancelModalBtn = document.getElementById("cancelModalBtn");

  function newSessionId() {
    if (crypto?.randomUUID) return crypto.randomUUID();
    return "sess_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function loadState() {
    try { patient = JSON.parse(localStorage.getItem(LS_PATIENT) || "null"); } catch { patient = null; }
    try { messages = JSON.parse(localStorage.getItem(LS_MESSAGES) || "[]"); } catch { messages = []; }
    try { faqFlow = JSON.parse(localStorage.getItem(LS_FLOW) || "null"); } catch { faqFlow = null; }

    sessionId = localStorage.getItem(LS_SESSION);
    if (!sessionId) {
      sessionId = newSessionId();
      localStorage.setItem(LS_SESSION, sessionId);
    }
  }

  function saveMessages() { localStorage.setItem(LS_MESSAGES, JSON.stringify(messages)); }
  function saveFlow() {
    if (faqFlow) localStorage.setItem(LS_FLOW, JSON.stringify(faqFlow));
    else localStorage.removeItem(LS_FLOW);
  }

  function setMeta() {
    if (patient?.name && patient?.dob) {
      elPatientMeta.textContent = `ログ識別：${patient.name} / ${patient.dob}`;
    } else {
      elPatientMeta.textContent = "ログ識別：未設定";
    }
    elSessionMeta.textContent = `セッション：${sessionId}`;
  }

  function openModal() { modalBg.style.display = "flex"; }
  function closeModal() { modalBg.style.display = "none"; }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function linkify(text) {
    const esc = escapeHtml(text);
    const urlRe = /(https?:\/\/[^\s]+)/g;
    return esc.replace(urlRe, (m) => {
      const u = m;
      return `<a href="${u}" target="_blank" rel="noopener noreferrer">${u}</a>`;
    });
  }

  function addBubble(role, text) {
    const row = document.createElement("div");
    row.className = `row ${role === "user" ? "user" : "assistant"}`;

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.innerHTML = linkify(text);

    row.appendChild(bubble);
    elChat.appendChild(row);
    elChat.scrollTop = elChat.scrollHeight;
  }

  function renderAll() {
    elChat.innerHTML = "";
    for (const m of messages) addBubble(m.role, m.content);
  }

  function showEndButton(show) {
    elEndBtn.style.display = show ? "inline-flex" : "none";
  }

  function addAssistantIntro() {
    const intro = "ご用件を入力してください。\n例）歯が痛い／詰め物が取れた／しみる／腫れた など";
    messages.push({ role: "assistant", content: intro, ts: Date.now() });
    saveMessages();
    renderAll();
  }

  // ★会話履歴だけ消す（patientは残す）
  function endConversationKeepPatient() {
    messages = [];
    faqFlow = null;

    localStorage.removeItem(LS_MESSAGES);
    localStorage.removeItem(LS_FLOW);

    sessionId = newSessionId();
    localStorage.setItem(LS_SESSION, sessionId);

    renderAll();
    setMeta();
    showEndButton(false);
    addAssistantIntro();
  }

  async function ping() {
    try {
      const res = await fetch(API_PING, { method: "GET" });
      if (res.ok) {
        elStatus.textContent = "オンライン";
        return;
      }
    } catch {}
    elStatus.textContent = "接続確認できません（送信は試せます）";
  }

  async function sendMessage(text) {
    const t = String(text || "").trim();
    if (!t) return;

    if (!patient?.consent || !patient?.name || !patient?.dob) {
      openModal();
      return;
    }

    messages.push({ role: "user", content: t, ts: Date.now() });
    saveMessages();
    renderAll();

    elInput.value = "";
    elSend.disabled = true;
    elStatus.textContent = "送信中…";

    const payload = {
      messages: messages.map(m => ({ role: m.role, content: m.content })),
      session_id: sessionId,
      patient: { name: patient.name, dob: patient.dob },
      page_url: location.href,
      user_agent: navigator.userAgent,
      faq_flow: faqFlow
    };

    try {
      const res = await fetch(API_CHAT, {
        method: "POST",
        headers: { "Content-Type": "application/json; charset=utf-8" },
        body: JSON.stringify(payload)
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok) {
        const msg = data?.error ? `エラー：${data.error}` : "エラーが発生しました。";
        messages.push({ role: "assistant", content: msg, ts: Date.now() });
        saveMessages();
        renderAll();
        elStatus.textContent = "エラー";
        return;
      }

      const reply = String(data.reply || "すみません、うまく回答できませんでした。");
      messages.push({ role: "assistant", content: reply, ts: Date.now() });
      saveMessages();

      faqFlow = data.faq_flow || null;
      saveFlow();

      showEndButton(!!data.suggest_end);

      renderAll();
      elStatus.textContent = "オンライン";
    } catch (e) {
      messages.push({ role: "assistant", content: "通信に失敗しました。時間をおいてお試しください。", ts: Date.now() });
      saveMessages();
      renderAll();
      elStatus.textContent = "通信失敗";
    } finally {
      elSend.disabled = false;
    }
  }

  // chips
  document.querySelectorAll(".chip").forEach(btn => {
    btn.addEventListener("click", () => {
      const txt = btn.getAttribute("data-text") || "";
      sendMessage(txt);
    });
  });

  // send
  elSend.addEventListener("click", () => sendMessage(elInput.value));
  elInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage(elInput.value);
    }
  });

  // end button (keep patient)
  elEndBtn.addEventListener("click", () => {
    endConversationKeepPatient();
  });

  // reset patient (完全リセット)
  elResetPatientBtn.addEventListener("click", () => {
    if (!confirm("入力情報（氏名・生年月日）も含めてリセットしますか？")) return;

    localStorage.removeItem(LS_PATIENT);
    localStorage.removeItem(LS_MESSAGES);
    localStorage.removeItem(LS_FLOW);

    patient = null;
    messages = [];
    faqFlow = null;

    sessionId = newSessionId();
    localStorage.setItem(LS_SESSION, sessionId);

    setMeta();
    renderAll();
    showEndButton(false);
    openModal();
  });

  // modal actions
  saveModalBtn.addEventListener("click", () => {
    const consent = (consentInput.value || "").trim();
    const name = (nameInput.value || "").trim();
    const dob = (dobInput.value || "").trim();

    if (consent !== "同意します") {
      alert("同意欄に「同意します」と入力してください。");
      return;
    }
    if (!name) {
      alert("お名前を入力してください。");
      return;
    }
    if (!/^\d{4}-\d{2}-\d{2}$/.test(dob)) {
      alert("生年月日は YYYY-MM-DD 形式で入力してください。");
      return;
    }

    patient = { consent: true, name, dob };
    localStorage.setItem(LS_PATIENT, JSON.stringify(patient));

    closeModal();
    setMeta();

    if (messages.length === 0) addAssistantIntro();
  });

  cancelModalBtn.addEventListener("click", () => closeModal());

  // init
  (async function init() {
    loadState();
    setMeta();
    renderAll();

    if (!patient?.consent || !patient?.name || !patient?.dob) {
      openModal();
    } else {
      if (messages.length === 0) addAssistantIntro();
    }

    await ping();
  })();
</script>
</body>
</html>
