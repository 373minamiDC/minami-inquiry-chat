<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>みなみ歯科医院｜お問い合わせAI</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1b33; --card:#122446; --card2:#0e1a34;
      --text:#e8eefc; --muted:#b8c3dd; --brand:#4ea1ff; --brand2:#2f7be6;
      --danger:#ff4d4d; --line:#243a63;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#071022, #0b1220 40%, #071022);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif}
    a{color:var(--brand);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:980px;margin:0 auto;padding:22px 14px 30px}
    .shell{background:rgba(10,18,36,.55);border:1px solid rgba(78,161,255,.12);border-radius:24px;box-shadow:0 16px 48px rgba(0,0,0,.35);overflow:hidden}
    .top{padding:18px 18px 10px;border-bottom:1px solid rgba(78,161,255,.10);display:flex;gap:12px;align-items:center}
    .title{font-weight:800;font-size:16px}
    .badge{font-size:12px;color:var(--muted);background:rgba(78,161,255,.10);border:1px solid rgba(78,161,255,.16);padding:6px 10px;border-radius:999px}
    .notice{padding:12px 18px;background:rgba(255,255,255,.02);border-bottom:1px solid rgba(78,161,255,.10);color:var(--muted)}
    .notice b{color:var(--text)}
    .meta{padding:10px 18px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;color:var(--muted);font-size:12px}
    .meta code{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);padding:2px 6px;border-radius:8px;color:var(--text)}
    .chat{height:min(62vh,720px);overflow:auto;padding:14px 18px 8px}
    .row{display:flex;margin:10px 0}
    .row.assistant{justify-content:flex-start}
    .row.user{justify-content:flex-end}
    .bubble{
      max-width:min(680px, 88%);
      padding:12px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.08);
      white-space:pre-wrap;
      word-break:break-word;
    }
    .assistant .bubble{background:rgba(18,36,70,.55)}
    .user .bubble{background:rgba(78,161,255,.18);border-color:rgba(78,161,255,.25)}
    .bubble .small{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:rgba(78,161,255,.10);margin:10px 0}
    .chips{padding:10px 18px 0;display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      border-radius:999px;
      padding:7px 12px;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{border-color:rgba(78,161,255,.30);background:rgba(78,161,255,.10)}
    .quickWrap{padding:10px 18px 0;display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .quickTitle{color:var(--muted);font-size:12px;margin-right:6px}
    .quickBtn{
      border-radius:12px;
      padding:9px 12px;
      border:1px solid rgba(78,161,255,.25);
      background:rgba(78,161,255,.12);
      color:var(--text);
      cursor:pointer;
      min-width:46px;
      text-align:center;
      font-weight:700;
    }
    .quickBtn:hover{background:rgba(78,161,255,.18)}
    .quickBtn.ghost{border-color:rgba(255,255,255,.12);background:rgba(255,255,255,.06);font-weight:600}
    .composer{padding:12px 18px 18px;border-top:1px solid rgba(78,161,255,.10)}
    .inputRow{display:flex;gap:10px;align-items:stretch}
    textarea{
      width:100%;resize:none;min-height:52px;max-height:180px;
      border-radius:16px;border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.20);color:var(--text);
      padding:12px 12px;outline:none;
    }
    textarea:focus{border-color:rgba(78,161,255,.30)}
    .send{
      width:90px;border-radius:16px;border:1px solid rgba(78,161,255,.25);
      background:linear-gradient(180deg, rgba(78,161,255,.22), rgba(78,161,255,.12));
      color:var(--text);font-weight:800;cursor:pointer;
    }
    .send:disabled{opacity:.5;cursor:not-allowed}
    .foot{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:10px;color:var(--muted);font-size:12px}
    .dangerBtn{
      background:rgba(255,77,77,.10);
      border:1px solid rgba(255,77,77,.25);
      color:var(--text);
      padding:10px 14px;border-radius:14px;
      cursor:pointer;font-weight:800;
    }
    .dangerBtn:hover{background:rgba(255,77,77,.14)}
    .linkBtn{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      padding:10px 14px;border-radius:14px;
      cursor:pointer;font-weight:700;
    }
    .linkBtn:hover{border-color:rgba(78,161,255,.25)}
    /* modal */
    .modalBg{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:18px}
    .modal{width:min(520px, 100%);background:rgba(15,27,51,.98);border:1px solid rgba(78,161,255,.18);border-radius:22px;box-shadow:0 20px 60px rgba(0,0,0,.5);padding:18px}
    .modal h2{margin:0 0 8px;font-size:16px}
    .modal p{margin:8px 0;color:var(--muted)}
    .formRow{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .field{flex:1;min-width:220px}
    label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
    input[type="text"], input[type="date"]{
      width:100%;border-radius:14px;border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.20);color:var(--text);
      padding:11px 12px;outline:none;
    }
    input[type="text"]:focus, input[type="date"]:focus{border-color:rgba(78,161,255,.30)}
    .agreeRow{display:flex;gap:10px;align-items:flex-start;margin-top:10px}
    .agreeRow input{margin-top:4px;transform:scale(1.1)}
    .modalActions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
    .primary{
      border-radius:14px;padding:10px 14px;border:1px solid rgba(78,161,255,.25);
      background:rgba(78,161,255,.14);color:var(--text);
      cursor:pointer;font-weight:800;
    }
    .primary:hover{background:rgba(78,161,255,.18)}
    .mutedBtn{
      border-radius:14px;padding:10px 14px;border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);color:var(--text);
      cursor:pointer;font-weight:700;
    }
    .mutedBtn:hover{border-color:rgba(78,161,255,.22)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="shell">
    <div class="top">
      <div class="title">お問い合わせAI</div>
      <div class="badge">必要に応じて受診をご案内します</div>
    </div>

    <div class="notice">
      ※このチャットは<b>診断の確定は行いません</b>。<br/>
      強い痛み／出血が止まらない／息苦しさ／外傷など緊急性がある場合は、当院までお電話ください（診療時間内のみ対応）：<b><a href="tel:0798478111">0798-47-8111</a></b><br/>
      ※会話内容は院内対応確認のため記録されます（同意の上ご利用ください）。
    </div>

    <div class="meta">
      <span>ログ識別： <code id="metaName">-</code> / <code id="metaDob">-</code></span>
      <span style="margin-left:auto">セッション： <code id="metaSession">-</code></span>
    </div>

    <div id="chat" class="chat"></div>

    <div class="chips">
      <div class="chip" data-text="痛い">痛い</div>
      <div class="chip" data-text="詰め物が取れた">詰め物が取れた</div>
      <div class="chip" data-text="しみる">しみる</div>
      <div class="chip" data-text="腫れた">腫れた</div>
      <div class="chip" data-text="予約の確認">予約の確認</div>
    </div>

    <div id="quickWrap" class="quickWrap" style="display:none"></div>

    <div class="composer">
      <div class="inputRow">
        <textarea id="input" placeholder="例：今日 右上の奥歯の詰め物が取れた など"></textarea>
        <button id="send" class="send">送信</button>
      </div>
      <div class="foot">
        <div>共有端末の場合は最後に「会話を終了（履歴を消す）」を押してください（氏名・生年月日は残ります）。</div>
        <div style="display:flex;gap:10px;align-items:center">
          <button id="endBtn" class="linkBtn" title="会話履歴のみ削除（氏名・生年月日は残す）">会話を終了（履歴を消す）</button>
          <button id="resetAllBtn" class="dangerBtn" title="氏名・生年月日も含めてリセット">入力情報リセット</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Consent / Patient modal -->
<div id="modalBg" class="modalBg">
  <div class="modal">
    <h2>ご利用前の確認</h2>
    <p>チャットの内容は院内対応の参考のため記録されます。診断の確定は行いません。</p>
    <div class="formRow">
      <div class="field">
        <label>氏名</label>
        <input id="nameInput" type="text" placeholder="例：南 太郎" autocomplete="name"/>
      </div>
      <div class="field">
        <label>生年月日</label>
        <input id="dobInput" type="date" />
      </div>
    </div>
    <div class="agreeRow">
      <input id="agreeChk" type="checkbox" />
      <div>
        <div style="font-weight:800">同意します</div>
        <div style="color:var(--muted);font-size:12px">会話ログの記録に同意のうえ利用します。</div>
      </div>
    </div>
    <div class="modalActions">
      <button id="modalCancel" class="mutedBtn">閉じる</button>
      <button id="modalOk" class="primary">開始する</button>
    </div>
  </div>
</div>

<script>
  // ===== 設定 =====
  const API_URL = "https://minami-inquiry-ai.373minami-dc.workers.dev/api/chat";

  // ===== localStorage keys =====
  const K_PATIENT = "minami_patient";
  const K_SESSION  = "minami_session_id";
  const K_MESSAGES = "minami_messages";
  const K_FLOW     = "minami_faq_flow";

  // ===== state =====
  let patient = loadJSON(K_PATIENT, null);
  let sessionId = localStorage.getItem(K_SESSION) || newSessionId();
  let messages = loadJSON(K_MESSAGES, []);
  let faqFlow = loadJSON(K_FLOW, null);

  // ===== DOM =====
  const chatEl = document.getElementById("chat");
  const inputEl = document.getElementById("input");
  const sendBtn = document.getElementById("send");
  const quickWrap = document.getElementById("quickWrap");

  const metaName = document.getElementById("metaName");
  const metaDob = document.getElementById("metaDob");
  const metaSession = document.getElementById("metaSession");

  const modalBg = document.getElementById("modalBg");
  const nameInput = document.getElementById("nameInput");
  const dobInput = document.getElementById("dobInput");
  const agreeChk = document.getElementById("agreeChk");
  const modalOk = document.getElementById("modalOk");
  const modalCancel = document.getElementById("modalCancel");

  const endBtn = document.getElementById("endBtn");
  const resetAllBtn = document.getElementById("resetAllBtn");

  // ===== init =====
  updateMeta();
  renderAll();

  if (!patient || !patient.name || !patient.dob) {
    openModal();
  } else {
    greetIfEmpty();
  }

  // ===== UI events =====
  document.querySelectorAll(".chip").forEach(ch => {
    ch.addEventListener("click", () => {
      inputEl.value = ch.dataset.text || "";
      inputEl.focus();
    });
  });

  sendBtn.addEventListener("click", () => sendMessage());
  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  endBtn.addEventListener("click", () => endConversation());

  resetAllBtn.addEventListener("click", () => {
    if (!confirm("氏名・生年月日も含めてリセットします。よろしいですか？")) return;
    localStorage.removeItem(K_PATIENT);
    endConversation(true); // also clears session and everything
    openModal();
  });

  modalCancel.addEventListener("click", () => closeModal());
  modalOk.addEventListener("click", () => {
    const name = (nameInput.value || "").trim();
    const dob = (dobInput.value || "").trim();
    if (!agreeChk.checked) { alert("「同意します」にチェックを入れてください。"); return; }
    if (!name) { alert("氏名を入力してください。"); return; }
    if (!dob) { alert("生年月日を入力してください。"); return; }

    patient = { name, dob };
    saveJSON(K_PATIENT, patient);
    updateMeta();
    closeModal();
    greetIfEmpty();
  });

  // ===== functions =====
  function openModal(){
    modalBg.style.display = "flex";
    nameInput.value = patient?.name || "";
    dobInput.value = patient?.dob || "";
    agreeChk.checked = false;
  }
  function closeModal(){ modalBg.style.display = "none"; }

  function greetIfEmpty(){
    if (!Array.isArray(messages) || messages.length === 0) {
      addAssistant(`ご用件を入力してください。\n例）歯が痛い／詰め物が取れた／しみる／腫れた など`);
      persist();
    }
  }

  function updateMeta(){
    metaName.textContent = patient?.name || "-";
    metaDob.textContent = patient?.dob || "-";
    metaSession.textContent = sessionId || "-";
  }

  function newSessionId(){
    const s = (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + "-" + Math.random().toString(16).slice(2));
    localStorage.setItem(K_SESSION, s);
    return s;
  }

  function endConversation(forceNewSession=false){
    // 履歴だけ消して、氏名・生年月日は残す運用
    messages = [];
    faqFlow = null;
    localStorage.removeItem(K_MESSAGES);
    localStorage.removeItem(K_FLOW);

    if (forceNewSession || true) {
      sessionId = newSessionId();
    }

    chatEl.innerHTML = "";
    quickWrap.style.display = "none";
    updateMeta();
    greetIfEmpty();
  }

  async function sendMessage(textOverride){
    if (!patient || !patient.name || !patient.dob) { openModal(); return; }

    const text = (textOverride !== undefined ? textOverride : inputEl.value).trim();
    if (!text) return;

    inputEl.value = "";
    addUser(text);
    persist();
    scrollToBottom();

    // send
    setSending(true);
    try{
      const payload = {
        messages,
        session_id: sessionId,
        patient,
        page_url: location.href,
        user_agent: navigator.userAgent,
        faq_flow: faqFlow
      };

      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json; charset=utf-8" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error("API error: " + res.status);
      const data = await res.json();

      const reply = (data?.reply || "").toString();
      faqFlow = data?.faq_flow ?? null;
      saveJSON(K_FLOW, faqFlow);

      addAssistant(reply, { suggestEnd: !!data?.suggest_end });
      persist();

      // クイックボタン表示更新
      updateQuickButtons(reply, !!data?.suggest_end);

      scrollToBottom();
    }catch(err){
      addAssistant("通信エラーが発生しました。時間をおいて再度お試しください。");
      persist();
    }finally{
      setSending(false);
    }
  }

  function setSending(isSending){
    sendBtn.disabled = isSending;
    inputEl.disabled = isSending;
  }

  function addUser(text){
    messages.push({ role:"user", content:text });
    renderMessage({ role:"user", content:text });
  }

  function addAssistant(text, opts={}){
    messages.push({ role:"assistant", content:text });
    renderMessage({ role:"assistant", content:text }, opts);
  }

  function renderAll(){
    chatEl.innerHTML = "";
    (messages || []).forEach(m => renderMessage(m));
    // 初期 quick
    const lastA = [...(messages||[])].reverse().find(m => m.role === "assistant")?.content || "";
    updateQuickButtons(lastA, false);
    scrollToBottom(true);
  }

  function renderMessage(m, opts={}){
    const row = document.createElement("div");
    row.className = "row " + (m.role === "user" ? "user" : "assistant");

    const bubble = document.createElement("div");
    bubble.className = "bubble";

    bubble.innerHTML = linkify(escapeHtml(m.content || ""));

    // 最終回答っぽい時は、チャット内に「会話を終了」ボタンを出す
    if (m.role === "assistant" && (opts.suggestEnd || looksLikeFinal(m.content))) {
      const div = document.createElement("div");
      div.className = "divider";
      bubble.appendChild(div);

      const btn = document.createElement("button");
      btn.className = "linkBtn";
      btn.textContent = "会話を終了（履歴を消す）";
      btn.addEventListener("click", () => endConversation());
      bubble.appendChild(btn);

      const note = document.createElement("div");
      note.className = "small";
      note.textContent = "※氏名・生年月日は残ります。共有端末では押してください。";
      bubble.appendChild(note);
    }

    row.appendChild(bubble);
    chatEl.appendChild(row);
  }

  function updateQuickButtons(lastAssistantText, suggestEndFlag){
    const txt = String(lastAssistantText || "");

    // まず全消し
    quickWrap.innerHTML = "";
    quickWrap.style.display = "none";

    const buttons = [];

    // yes/no
    if (hasYesNoPrompt(txt)) {
      buttons.push({ label:"はい", value:"はい" });
      buttons.push({ label:"いいえ", value:"いいえ" });
    }

    // choice 1/2/3
    const choices = detectChoices(txt); // returns [1,2] or [1,2,3]
    if (choices.length) {
      choices.forEach(n => buttons.push({ label:String(n), value:String(n) }));
      // よくある文字回答も出す（迷う人向け）
      if (choices.length === 2) {
        buttons.push({ label:"ある", value:"ある", ghost:true });
        buttons.push({ label:"ない", value:"ない", ghost:true });
      }
    }

    // end conversation button hint (if server says suggest_end)
    if (suggestEndFlag) {
      buttons.push({ label:"会話を終了", value:"__END__", ghost:true });
    }

    if (!buttons.length) return;

    quickWrap.style.display = "flex";
    const title = document.createElement("div");
    title.className = "quickTitle";
    title.textContent = "クイック返信：";
    quickWrap.appendChild(title);

    buttons.forEach(b => {
      const btn = document.createElement("button");
      btn.className = "quickBtn" + (b.ghost ? " ghost" : "");
      btn.textContent = b.label;
      btn.addEventListener("click", () => {
        if (b.value === "__END__") return endConversation();
        sendMessage(b.value);
      });
      quickWrap.appendChild(btn);
    });
  }

  function hasYesNoPrompt(t){
    // 「（はい／いいえ）」や「はい／いいえ」「はい/いいえ」などが含まれる
    return /はい\s*[\/／]\s*いいえ|（\s*はい\s*[\/／]\s*いいえ\s*）/i.test(t);
  }

  function detectChoices(t){
    // 「1：」「2：」「3：」や「1:」などを検知
    const has1 = /(?:^|\n|\s)1\s*[：:]/.test(t);
    const has2 = /(?:^|\n|\s)2\s*[：:]/.test(t);
    const has3 = /(?:^|\n|\s)3\s*[：:]/.test(t);

    if (has1 && has2 && has3) return [1,2,3];
    if (has1 && has2) return [1,2];
    return [];
  }

  function looksLikeFinal(t){
    const s = String(t || "");
    // 予約導線 or 電話/WEBが出たら final っぽい
    if (s.includes("WEB予約") || s.includes("https://v3.apodent.jp/")) return true;
    if (s.includes("0798-47-8111") || s.includes("お電話")) return true;
    if (s.includes("会話を終了")) return true;
    return false;
  }

  function persist(){
    saveJSON(K_MESSAGES, messages);
    localStorage.setItem(K_SESSION, sessionId);
    saveJSON(K_FLOW, faqFlow);
  }

  function scrollToBottom(instant=false){
    requestAnimationFrame(() => {
      chatEl.scrollTo({ top: chatEl.scrollHeight, behavior: instant ? "auto" : "smooth" });
    });
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function linkify(s){
    // URLs
    s = s.replace(/(https?:\/\/[^\s<]+)|(\bwww\.[^\s<]+)/g, (m) => {
      const url = m.startsWith("http") ? m : "https://" + m;
      return `<a href="${url}" target="_blank" rel="noopener noreferrer">${m}</a>`;
    });

    // phone number (0798-47-8111 etc.)
    s = s.replace(/0\d{1,4}-\d{1,4}-\d{3,4}/g, (m) => {
      const tel = "tel:" + m.replaceAll("-","");
      return `<a href="${tel}">${m}</a>`;
    });

    return s;
  }

  function loadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      return JSON.parse(raw);
    }catch{ return fallback; }
  }
  function saveJSON(key, val){
    try{
      localStorage.setItem(key, JSON.stringify(val));
    }catch{}
  }
</script>
</body>
</html>
